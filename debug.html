<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberWise Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .reset-btn {
            background: #28a745;
        }
        .reset-btn:hover {
            background: #218838;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ CyberWise è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>1. Firebase è¿æ¥æµ‹è¯•</h2>
        <button onclick="testFirebaseConnection()">æµ‹è¯• Firebase è¿æ¥</button>
        <div id="firebase-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>2. æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·</h2>
        <button onclick="listAllUsers()">åˆ—å‡ºæ‰€æœ‰æ³¨å†Œç”¨æˆ·</button>
        <div id="users-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>3. æµ‹è¯•ç™»å½•</h2>
        <input type="text" id="test-email" placeholder="è¾“å…¥é‚®ç®±">
        <input type="password" id="test-password" placeholder="è¾“å…¥å¯†ç ">
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <div id="login-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>4. å¯†ç é‡ç½®</h2>
        <input type="email" id="reset-email" placeholder="è¾“å…¥è¦é‡ç½®å¯†ç çš„é‚®ç®±">
        <button class="reset-btn" onclick="resetPassword()">å‘é€å¯†ç é‡ç½®é‚®ä»¶</button>
        <div id="reset-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>5. ä¿®å¤ç”¨æˆ·æ•°æ®</h2>
        <input type="text" id="fix-username" placeholder="ç”¨æˆ·å">
        <input type="email" id="fix-email" placeholder="é‚®ç®±">
        <button onclick="fixUserData()">ä¿®å¤ç”¨æˆ·æ•°æ®åˆ°Firestore</button>
        <div id="fix-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>6. åˆ›å»ºæµ‹è¯•ç”¨æˆ·</h2>
        <input type="text" id="new-username" placeholder="ç”¨æˆ·å">
        <input type="email" id="new-email" placeholder="é‚®ç®±">
        <input type="password" id="new-password" placeholder="å¯†ç ">
        <button onclick="createTestUser()">åˆ›å»ºæµ‹è¯•ç”¨æˆ·</button>
        <div id="create-result" class="result"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="static/js/firebase-init.js"></script>

    <script>
        function log(elementId, message) {
            document.getElementById(elementId).textContent = message;
            console.log(message);
        }

        function testFirebaseConnection() {
            try {
                log('firebase-result', 'æ­£åœ¨æµ‹è¯• Firebase è¿æ¥...');
                
                const app = firebase.app();
                const auth = firebase.auth();
                const firestore = firebase.firestore();
                
                const result = `âœ… Firebase è¿æ¥æˆåŠŸï¼
åº”ç”¨åç§°: ${app.name}
é¡¹ç›®ID: ${app.options.projectId}
è®¤è¯åŸŸ: ${app.options.authDomain}
Auth çŠ¶æ€: ${auth ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}
Firestore çŠ¶æ€: ${firestore ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}`;
                
                log('firebase-result', result);
            } catch (error) {
                log('firebase-result', `âŒ Firebase è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        async function listAllUsers() {
            try {
                log('users-result', 'æ­£åœ¨è·å–ç”¨æˆ·åˆ—è¡¨...');
                
                const usersSnapshot = await db.collection("users").get();
                const usernamesSnapshot = await db.collection("usernames").get();
                
                let result = `ğŸ“Š æ•°æ®åº“ç»Ÿè®¡:
ç”¨æˆ·æ–‡æ¡£æ•°é‡: ${usersSnapshot.size}
ç”¨æˆ·åæ˜ å°„æ•°é‡: ${usernamesSnapshot.size}

ç”¨æˆ·åˆ—è¡¨:
`;
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    result += `- ${data.username} (${data.email}) - åˆ›å»ºäº: ${data.createdAt ? data.createdAt.toDate().toLocaleString() : 'æœªçŸ¥'}\n`;
                });
                
                result += `\nç”¨æˆ·åæ˜ å°„:
`;
                usernamesSnapshot.forEach(doc => {
                    const data = doc.data();
                    result += `- ${doc.id} -> ${data.email}\n`;
                });
                
                log('users-result', result);
            } catch (error) {
                log('users-result', `âŒ è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testLogin() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            if (!email || !password) {
                log('login-result', 'âŒ è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
                return;
            }
            
            try {
                log('login-result', 'æ­£åœ¨å°è¯•ç™»å½•...');
                
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                const result = `âœ… ç™»å½•æˆåŠŸï¼
ç”¨æˆ·ID: ${user.uid}
é‚®ç®±: ${user.email}
æ˜¾ç¤ºåç§°: ${user.displayName || 'æœªè®¾ç½®'}
é‚®ç®±éªŒè¯: ${user.emailVerified ? 'å·²éªŒè¯' : 'æœªéªŒè¯'}
åˆ›å»ºæ—¶é—´: ${user.metadata.creationTime}
æœ€åç™»å½•: ${user.metadata.lastSignInTime}`;
                
                log('login-result', result);
                
                // ç™»å‡ºä»¥ä¾¿ç»§ç»­æµ‹è¯•
                await firebase.auth().signOut();
            } catch (error) {
                const result = `âŒ ç™»å½•å¤±è´¥
é”™è¯¯ä»£ç : ${error.code}
é”™è¯¯ä¿¡æ¯: ${error.message}

å¸¸è§è§£å†³æ–¹æ¡ˆ:
- æ£€æŸ¥é‚®ç®±å’Œå¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤è´¦æˆ·æ˜¯å¦å·²æ³¨å†Œ
- æ£€æŸ¥ç½‘ç»œè¿æ¥`;
                
                log('login-result', result);
            }
        }

        async function resetPassword() {
            const email = document.getElementById('reset-email').value;
            
            if (!email) {
                log('reset-result', 'âŒ è¯·è¾“å…¥é‚®ç®±åœ°å€');
                return;
            }
            
            try {
                log('reset-result', 'æ­£åœ¨å‘é€å¯†ç é‡ç½®é‚®ä»¶...');
                
                await firebase.auth().sendPasswordResetEmail(email);
                
                const result = `âœ… å¯†ç é‡ç½®é‚®ä»¶å·²å‘é€ï¼
é‚®ç®±: ${email}

è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹ï¼‰ï¼Œ
ç‚¹å‡»é‚®ä»¶ä¸­çš„é“¾æ¥é‡ç½®å¯†ç ã€‚`;
                
                log('reset-result', result);
            } catch (error) {
                let errorMessage = '';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'æœªæ‰¾åˆ°æ­¤é‚®ç®±å¯¹åº”çš„è´¦æˆ·';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'é‚®ç®±æ ¼å¼æ— æ•ˆ';
                        break;
                    default:
                        errorMessage = error.message;
                }
                log('reset-result', `âŒ å‘é€å¤±è´¥: ${errorMessage}`);
            }
        }

        async function fixUserData() {
            const username = document.getElementById('fix-username').value;
            const email = document.getElementById('fix-email').value;
            
            if (!username || !email) {
                log('fix-result', 'âŒ è¯·è¾“å…¥ç”¨æˆ·åå’Œé‚®ç®±');
                return;
            }
            
            try {
                log('fix-result', 'æ­£åœ¨ä¿®å¤ç”¨æˆ·æ•°æ®...');
                
                // å‡è®¾ç”¨æˆ·IDï¼Œå®é™…åº”è¯¥ä»Firebase Authè·å–
                const fakeUserId = 'user_' + Date.now();
                
                // åˆ›å»ºç”¨æˆ·æ–‡æ¡£
                await db.collection("users").doc(fakeUserId).set({
                    username: username,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    notesCount: 0
                });
                
                // åˆ›å»ºç”¨æˆ·åæ˜ å°„
                await db.collection("usernames").doc(username).set({
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: fakeUserId
                });
                
                const result = `âœ… ç”¨æˆ·æ•°æ®ä¿®å¤æˆåŠŸï¼
ç”¨æˆ·å: ${username}
é‚®ç®±: ${email}
ç”¨æˆ·ID: ${fakeUserId}

ç°åœ¨å¯ä»¥å°è¯•ç™»å½•äº†ã€‚`;
                
                log('fix-result', result);
            } catch (error) {
                log('fix-result', `âŒ ä¿®å¤å¤±è´¥: ${error.message}`);
            }
        }

        async function createTestUser() {
            const username = document.getElementById('new-username').value;
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            
            if (!username || !email || !password) {
                log('create-result', 'âŒ è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }
            
            try {
                log('create-result', 'æ­£åœ¨åˆ›å»ºæµ‹è¯•ç”¨æˆ·...');
                
                // åˆ›å»ºç”¨æˆ·è´¦æˆ·
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // æ›´æ–°æ˜¾ç¤ºåç§°
                await user.updateProfile({ displayName: username });
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await db.collection("users").doc(user.uid).set({
                    username: username,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    notesCount: 0
                });
                
                await db.collection("usernames").doc(username).set({
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: user.uid
                });
                
                const result = `âœ… æµ‹è¯•ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼
ç”¨æˆ·ID: ${user.uid}
ç”¨æˆ·å: ${username}
é‚®ç®±: ${email}
å¯†ç : ${password}

ç°åœ¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªè´¦æˆ·æµ‹è¯•ç™»å½•åŠŸèƒ½ã€‚`;
                
                log('create-result', result);
                
                // ç™»å‡º
                await firebase.auth().signOut();
            } catch (error) {
                log('create-result', `âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥: ${error.code} - ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            testFirebaseConnection();
        };
    </script>
</body>
</html> 